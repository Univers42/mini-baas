# ============================================
# ft_transcendence â€” Development Container (Optimized)
# ============================================
# Alpine-based Node.js 22 with everything for full-stack:
#   NestJS + React + Prisma + WebSockets + File uploads
#
# ðŸš€ OPTIMIZATIONS:
#   â€¢ Single RUN layer for apk (fewer layers = faster pull)
#   â€¢ npm cache preserved in named volume
#   â€¢ Global tools pinned to avoid unnecessary re-installs
#   â€¢ Healthcheck uses lightweight node eval (no curl overhead)
# ============================================

FROM node:22-alpine

# â”€â”€ System Dependencies (single layer) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Combined into ONE RUN to minimize image layers and build time.
# Each dependency serves a specific feature requirement:
#
#   bash, curl, jq, make    â†’ developer tooling / Makefile
#   git                     â†’ npm git deps if any
#   python3, g++, make      â†’ native module compilation (bcrypt, sharp, etc.)
#   openssl, libc6-compat   â†’ Prisma engine binary compatibility
#   postgresql16-client     â†’ psql CLI for DB debugging
#   redis                   â†’ redis-cli for cache debugging
#   imagemagick             â†’ image processing (file upload thumbnails)
#   file                    â†’ MIME type detection (file upload validation)
#   shadow                  â†’ usermod/groupadd (non-root setup)
RUN apk add --no-cache \
    bash curl git jq make psmisc procps \
    python3 g++ \
    openssl libc6-compat \
    postgresql16-client \
    redis \
    imagemagick \
    file \
    shadow \
    && rm -rf /var/cache/apk/*

# â”€â”€ Working Directory â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
WORKDIR /app

# â”€â”€ Enable pnpm via corepack (built-in Node â‰¥ 16) â”€â”€â”€
# pnpm is stricter about peer deps than npm, preventing
# phantom dependencies, version leaks and tree conflicts.
ENV PNPM_HOME="/pnpm" \
    PATH="/pnpm:$PATH"

# â”€â”€ Global Tools (pinned versions = reproducible) â”€â”€â”€â”€
# Installed once via pnpm, cached in image layer.
RUN corepack enable \
    && corepack prepare pnpm@latest --activate \
    && pnpm add -g \
        typescript@~5.7 \
        @nestjs/cli@~11 \
        prisma@~7 \
        concurrently@~9 \
    && pnpm approve-builds -g \
    && mkdir -p /app/uploads \
    && chmod 777 /app/uploads

# â”€â”€ Healthcheck (lightweight â€” no curl) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD node -e "process.exit(0)" || exit 1

# â”€â”€ Default: Keep Container Alive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
CMD ["tail", "-f", "/dev/null"]
