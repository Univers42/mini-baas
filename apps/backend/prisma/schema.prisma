// ============================================
// Prisma Schema — Transcendence
// ============================================
// Models:
//   • Users, profiles, friends      (user interaction)
//   • Chat messages                 (chat system)
//   • Notifications                 (notification system)
//   • File uploads                  (file management)
//   • API keys                      (public API)
//
// Run after editing:
//   pnpm exec prisma migrate dev --name <description>
//   pnpm exec prisma generate
// ============================================

generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ── Users & Authentication ──────────────────────────

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  username      String    @unique
  displayName   String?
  avatarUrl     String?
  bio           String?
  passwordHash  String?   // null for OAuth-only users
  is2FAEnabled  Boolean   @default(false)
  twoFASecret   String?
  status        UserStatus @default(OFFLINE)
  role          UserRole   @default(USER)
  lastSeenAt    DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // ── Relations ─────────────────────────────────────
  oauthAccounts OAuthAccount[]
  sentMessages     ChatMessage[]   @relation("SentMessages")
  sentFriendReqs   Friendship[]    @relation("FriendRequester")
  recvFriendReqs   Friendship[]    @relation("FriendReceiver")
  notifications    Notification[]
  files            FileUpload[]
  apiKeys          ApiKey[]
  channelMembers   ChannelMember[]

  @@map("users")
}

enum UserStatus {
  ONLINE
  OFFLINE
  BUSY
  AWAY
}

enum UserRole {
  USER
  ADMIN
}

// ── OAuth Accounts (42, Google, etc.) ───────────────

model OAuthAccount {
  id          String   @id @default(uuid())
  provider    String   // "42", "google", etc.
  providerId  String
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@unique([provider, providerId])
  @@map("oauth_accounts")
}

// ── Friendships ─────────────────────────────────────

model Friendship {
  id          String           @id @default(uuid())
  requesterId String
  receiverId  String
  status      FriendshipStatus @default(PENDING)
  requester   User             @relation("FriendRequester", fields: [requesterId], references: [id], onDelete: Cascade)
  receiver    User             @relation("FriendReceiver", fields: [receiverId], references: [id], onDelete: Cascade)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  @@unique([requesterId, receiverId])
  @@map("friendships")
}

enum FriendshipStatus {
  PENDING
  ACCEPTED
  BLOCKED
}

// ── Chat ────────────────────────────────────────────

model Channel {
  id          String          @id @default(uuid())
  name        String?
  type        ChannelType     @default(DIRECT)
  isPrivate   Boolean         @default(false)
  password    String?         // hashed, for protected channels
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  messages    ChatMessage[]
  members     ChannelMember[]

  @@map("channels")
}

enum ChannelType {
  DIRECT
  GROUP
  PUBLIC
}

model ChannelMember {
  id        String            @id @default(uuid())
  role      ChannelMemberRole @default(MEMBER)
  isMuted   Boolean           @default(false)
  mutedUntil DateTime?
  isBanned  Boolean           @default(false)
  userId    String
  channelId String
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  channel   Channel           @relation(fields: [channelId], references: [id], onDelete: Cascade)
  joinedAt  DateTime          @default(now())

  @@unique([userId, channelId])
  @@map("channel_members")
}

enum ChannelMemberRole {
  OWNER
  ADMIN
  MEMBER
}

model ChatMessage {
  id        String   @id @default(uuid())
  content   String
  senderId  String
  channelId String
  sender    User     @relation("SentMessages", fields: [senderId], references: [id], onDelete: Cascade)
  channel   Channel  @relation(fields: [channelId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([channelId, createdAt])
  @@map("chat_messages")
}

// ── Notifications ───────────────────────────────────

model Notification {
  id        String             @id @default(uuid())
  type      NotificationType
  title     String
  message   String
  isRead    Boolean            @default(false)
  metadata  Json?              // flexible payload
  userId    String
  user      User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt DateTime           @default(now())

  @@index([userId, isRead, createdAt])
  @@map("notifications")
}

enum NotificationType {
  FRIEND_REQUEST
  FRIEND_ACCEPTED
  CHAT_MESSAGE
  SYSTEM
  FILE_SHARED
}

// ── File Uploads ────────────────────────────────────

model FileUpload {
  id          String   @id @default(uuid())
  filename    String   // original filename
  storedName  String   // UUID-based stored name
  mimeType    String
  size        Int      // bytes
  path        String   // storage path
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@index([userId])
  @@map("file_uploads")
}

// ── Public API Keys ─────────────────────────────────

model ApiKey {
  id          String   @id @default(uuid())
  name        String
  keyHash     String   @unique // hashed API key
  lastUsedAt  DateTime?
  expiresAt   DateTime?
  isActive    Boolean  @default(true)
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())

  @@map("api_keys")
}
